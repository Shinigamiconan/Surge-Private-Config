name: Advanced ACL4SSR Sync

on:
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 2:00 è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 10:00ï¼‰
    - cron: '0 2 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main, master ]
    paths-ignore:
      - 'Online_Full.ini'
      - '.github/workflows/sync-acl4ssr.yml'

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout current repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Setup Git
      run: |
        git config --global user.email "action@github.com"
        git config --global user.name "GitHub Action"
    
    - name: Backup important files
      run: |
        # å¤‡ä»½é‡è¦æ–‡ä»¶
        mkdir -p backup
        if [ -f "Online_Full.ini" ]; then
          cp "Online_Full.ini" "backup/"
          echo "å·²å¤‡ä»½ Online_Full.ini"
        fi
        
        # å¤‡ä»½å…¶ä»–é‡è¦é…ç½®æ–‡ä»¶
        for file in *.ini *.yml *.yaml *.json; do
          if [ -f "$file" ] && [ "$file" != "Online_Full.ini" ]; then
            cp "$file" "backup/" 2>/dev/null || true
          fi
        done
    
    - name: Clone ACL4SSR repository
      run: |
        git clone --depth 1 --branch master https://github.com/Shinigamiconan/ACL4SSR.git temp_acl4ssr
    
    - name: Sync files selectively
      run: |
        # åŒæ­¥ Clash è§„åˆ™æ–‡ä»¶
        if [ -d "temp_acl4ssr/Clash" ]; then
          rsync -av --exclude='*.ini' temp_acl4ssr/Clash/ ./Clash/
        fi
        
        # åŒæ­¥ Acl æ–‡ä»¶
        if [ -d "temp_acl4ssr/Acl" ]; then
          rsync -av temp_acl4ssr/Acl/ ./Acl/
        fi
        
        # åŒæ­¥å…¶ä»–é‡è¦æ–‡ä»¶
        for file in README.md LICENSE; do
          if [ -f "temp_acl4ssr/$file" ]; then
            cp "temp_acl4ssr/$file" "./"
          fi
        done
        
        # æ¸…ç†ä¸´æ—¶ç›®å½•
        rm -rf temp_acl4ssr
    
    - name: Restore important files
      run: |
        # æ¢å¤é‡è¦æ–‡ä»¶
        if [ -f "backup/Online_Full.ini" ]; then
          cp "backup/Online_Full.ini" "./"
          echo "å·²æ¢å¤ Online_Full.ini"
        fi
        
        # æ¢å¤å…¶ä»–å¤‡ä»½çš„é…ç½®æ–‡ä»¶
        for file in backup/*.ini backup/*.yml backup/*.yaml backup/*.json; do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            if [ "$filename" != "Online_Full.ini" ]; then
              cp "$file" "./"
            fi
          fi
        done
        
        # æ¸…ç†å¤‡ä»½ç›®å½•
        rm -rf backup
    
    - name: Check for changes
      id: changes
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "æ£€æµ‹åˆ°å˜æ›´ï¼š"
          git status --short
        else
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "æ²¡æœ‰æ£€æµ‹åˆ°å˜æ›´"
        fi
    
    - name: Commit and push changes
      if: steps.changes.outputs.changes == 'true'
      run: |
        git add .
        git commit -m "ğŸ”„ Auto sync with ACL4SSR repository

        - åŒæ­¥æœ€æ–°çš„ Clash è§„åˆ™æ–‡ä»¶
        - åŒæ­¥æœ€æ–°çš„ Acl è§„åˆ™æ–‡ä»¶  
        - ä¿ç•™è‡ªå®šä¹‰é…ç½®æ–‡ä»¶ Online_Full.ini
        - è‡ªåŠ¨æ›´æ–°äº $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        git push
        echo "âœ… åŒæ­¥å®Œæˆå¹¶å·²æ¨é€åˆ°ä»“åº“"
    
    - name: No changes notification
      if: steps.changes.outputs.changes == 'false'
      run: |
        echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°å˜æ›´ï¼Œè·³è¿‡æäº¤"
